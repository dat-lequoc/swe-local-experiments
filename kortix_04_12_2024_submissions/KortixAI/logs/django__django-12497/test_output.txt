+ source /opt/miniconda3/bin/activate
++ _CONDA_ROOT=/opt/miniconda3
++ . /opt/miniconda3/etc/profile.d/conda.sh
+++ export CONDA_EXE=/opt/miniconda3/bin/conda
+++ CONDA_EXE=/opt/miniconda3/bin/conda
+++ export _CE_M=
+++ _CE_M=
+++ export _CE_CONDA=
+++ _CE_CONDA=
+++ export CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
+++ CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
+++ '[' -z '' ']'
+++ export CONDA_SHLVL=0
+++ CONDA_SHLVL=0
+++ '[' -n '' ']'
+++++ dirname /opt/miniconda3/bin/conda
++++ dirname /opt/miniconda3/bin
+++ PATH=/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
+++ export PATH
+++ '[' -z '' ']'
+++ PS1=
++ conda activate
++ local cmd=activate
++ case "$cmd" in
++ __conda_activate activate
++ '[' -n '' ']'
++ local ask_conda
+++ PS1=
+++ __conda_exe shell.posix activate
+++ /opt/miniconda3/bin/conda shell.posix activate
++ ask_conda='PS1='\''(base) '\''
export PATH='\''/opt/miniconda3/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'\''
export CONDA_PREFIX='\''/opt/miniconda3'\''
export CONDA_SHLVL='\''1'\''
export CONDA_DEFAULT_ENV='\''base'\''
export CONDA_PROMPT_MODIFIER='\''(base) '\''
export CONDA_EXE='\''/opt/miniconda3/bin/conda'\''
export _CE_M='\'''\''
export _CE_CONDA='\'''\''
export CONDA_PYTHON_EXE='\''/opt/miniconda3/bin/python'\'''
++ eval 'PS1='\''(base) '\''
export PATH='\''/opt/miniconda3/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'\''
export CONDA_PREFIX='\''/opt/miniconda3'\''
export CONDA_SHLVL='\''1'\''
export CONDA_DEFAULT_ENV='\''base'\''
export CONDA_PROMPT_MODIFIER='\''(base) '\''
export CONDA_EXE='\''/opt/miniconda3/bin/conda'\''
export _CE_M='\'''\''
export _CE_CONDA='\'''\''
export CONDA_PYTHON_EXE='\''/opt/miniconda3/bin/python'\'''
+++ PS1='(base) '
+++ export PATH=/opt/miniconda3/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
+++ PATH=/opt/miniconda3/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
+++ export CONDA_PREFIX=/opt/miniconda3
+++ CONDA_PREFIX=/opt/miniconda3
+++ export CONDA_SHLVL=1
+++ CONDA_SHLVL=1
+++ export CONDA_DEFAULT_ENV=base
+++ CONDA_DEFAULT_ENV=base
+++ export 'CONDA_PROMPT_MODIFIER=(base) '
+++ CONDA_PROMPT_MODIFIER='(base) '
+++ export CONDA_EXE=/opt/miniconda3/bin/conda
+++ CONDA_EXE=/opt/miniconda3/bin/conda
+++ export _CE_M=
+++ _CE_M=
+++ export _CE_CONDA=
+++ _CE_CONDA=
+++ export CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
+++ CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
++ __conda_hashr
++ '[' -n '' ']'
++ '[' -n '' ']'
++ hash -r
+ conda activate testbed
+ local cmd=activate
+ case "$cmd" in
+ __conda_activate activate testbed
+ '[' -n '' ']'
+ local ask_conda
++ PS1='(base) '
++ __conda_exe shell.posix activate testbed
++ /opt/miniconda3/bin/conda shell.posix activate testbed
+ ask_conda='PS1='\''(testbed) '\''
export PATH='\''/opt/miniconda3/envs/testbed/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'\''
export CONDA_PREFIX='\''/opt/miniconda3/envs/testbed'\''
export CONDA_SHLVL='\''2'\''
export CONDA_DEFAULT_ENV='\''testbed'\''
export CONDA_PROMPT_MODIFIER='\''(testbed) '\''
export CONDA_PREFIX_1='\''/opt/miniconda3'\''
export CONDA_EXE='\''/opt/miniconda3/bin/conda'\''
export _CE_M='\'''\''
export _CE_CONDA='\'''\''
export CONDA_PYTHON_EXE='\''/opt/miniconda3/bin/python'\'''
+ eval 'PS1='\''(testbed) '\''
export PATH='\''/opt/miniconda3/envs/testbed/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'\''
export CONDA_PREFIX='\''/opt/miniconda3/envs/testbed'\''
export CONDA_SHLVL='\''2'\''
export CONDA_DEFAULT_ENV='\''testbed'\''
export CONDA_PROMPT_MODIFIER='\''(testbed) '\''
export CONDA_PREFIX_1='\''/opt/miniconda3'\''
export CONDA_EXE='\''/opt/miniconda3/bin/conda'\''
export _CE_M='\'''\''
export _CE_CONDA='\'''\''
export CONDA_PYTHON_EXE='\''/opt/miniconda3/bin/python'\'''
++ PS1='(testbed) '
++ export PATH=/opt/miniconda3/envs/testbed/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
++ PATH=/opt/miniconda3/envs/testbed/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
++ export CONDA_PREFIX=/opt/miniconda3/envs/testbed
++ CONDA_PREFIX=/opt/miniconda3/envs/testbed
++ export CONDA_SHLVL=2
++ CONDA_SHLVL=2
++ export CONDA_DEFAULT_ENV=testbed
++ CONDA_DEFAULT_ENV=testbed
++ export 'CONDA_PROMPT_MODIFIER=(testbed) '
++ CONDA_PROMPT_MODIFIER='(testbed) '
++ export CONDA_PREFIX_1=/opt/miniconda3
++ CONDA_PREFIX_1=/opt/miniconda3
++ export CONDA_EXE=/opt/miniconda3/bin/conda
++ CONDA_EXE=/opt/miniconda3/bin/conda
++ export _CE_M=
++ _CE_M=
++ export _CE_CONDA=
++ _CE_CONDA=
++ export CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
++ CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
+ __conda_hashr
+ '[' -n '' ']'
+ '[' -n '' ']'
+ hash -r
+ cd /testbed
+ sed -i '/en_US.UTF-8/s/^# //g' /etc/locale.gen
+ locale-gen
Generating locales (this might take a while)...
  en_US.UTF-8... done
Generation complete.
+ export LANG=en_US.UTF-8
+ LANG=en_US.UTF-8
+ export LANGUAGE=en_US:en
+ LANGUAGE=en_US:en
+ export LC_ALL=en_US.UTF-8
+ LC_ALL=en_US.UTF-8
+ git config --global --add safe.directory /testbed
+ cd /testbed
+ git status
On branch main
Changes not staged for commit:
  (use "git add <file>..." to update what will be committed)
  (use "git restore <file>..." to discard changes in working directory)
	modified:   django/db/models/fields/related.py
	modified:   tests/m2m_through/models.py
	modified:   tests/m2m_through/tests.py

Untracked files:
  (use "git add <file>..." to include in what will be committed)
	reproduce_error.py
	test_models.py
	test_settings.py
	tests/m2m_through/test_settings.py

no changes added to commit (use "git add" and/or "git commit -a")
+ git show
commit a4881f5e5d7ee38b7e83301331a0b4962845ef8a
Author: 007gzs <007gzs@gmail.com>
Date:   Tue Feb 25 08:37:34 2020 +0800

    Fixed #31307 -- Fixed filter_horizontal add/remove SVG :hover positioning.

diff --git a/AUTHORS b/AUTHORS
index afc4ad0306..220533f648 100644
--- a/AUTHORS
+++ b/AUTHORS
@@ -534,6 +534,7 @@ answer newbie questions, and generally made Django that much better:
     Liang Feng <hutuworm@gmail.com>
     limodou
     Lincoln Smith <lincoln.smith@anu.edu.au>
+    Liu Yijie <007gzs@gmail.com>
     Loek van Gent <loek@barakken.nl>
     Lo√Øc Bistuer <loic.bistuer@sixmedia.com>
     Lowe Thiderman <lowe.thiderman@gmail.com>
diff --git a/django/contrib/admin/static/admin/css/responsive.css b/django/contrib/admin/static/admin/css/responsive.css
index b3db28fbf0..d7866c174e 100644
--- a/django/contrib/admin/static/admin/css/responsive.css
+++ b/django/contrib/admin/static/admin/css/responsive.css
@@ -354,6 +354,14 @@ input[type="submit"], button {
     }
 
     .stacked .active.selector-add {
+        background-position: 0 -40px;
+    }
+
+    .active.selector-add:focus, .active.selector-add:hover {
+        background-position: 0 -140px;
+    }
+
+    .stacked .active.selector-add:focus, .stacked .active.selector-add:hover {
         background-position: 0 -60px;
     }
 
@@ -362,6 +370,14 @@ input[type="submit"], button {
     }
 
     .stacked .active.selector-remove {
+        background-position: 0 0;
+    }
+
+    .active.selector-remove:focus, .active.selector-remove:hover {
+        background-position: 0 -100px;
+    }
+
+    .stacked .active.selector-remove:focus, .stacked .active.selector-remove:hover {
         background-position: 0 -20px;
     }
 
@@ -725,10 +741,18 @@ input[type="submit"], button {
         background-position: 0 0;
     }
 
+    .active.selector-remove:focus, .active.selector-remove:hover {
+        background-position: 0 -20px;
+    }
+
     .selector-add  {
         background-position: 0 -40px;
     }
 
+    .active.selector-add:focus, .active.selector-add:hover {
+        background-position: 0 -60px;
+    }
+
     /* Inlines */
 
     .inline-group[data-inline-type="stacked"] .inline-related {
diff --git a/django/contrib/admin/static/admin/css/widgets.css b/django/contrib/admin/static/admin/css/widgets.css
index 6dbc58e018..14ef12db94 100644
--- a/django/contrib/admin/static/admin/css/widgets.css
+++ b/django/contrib/admin/static/admin/css/widgets.css
@@ -211,6 +211,11 @@ a.active.selector-clearall:focus, a.active.selector-clearall:hover {
 }
 
 .stacked .active.selector-add {
+    background-position: 0 -32px;
+    cursor: pointer;
+}
+
+.stacked .active.selector-add:focus, .stacked .active.selector-add:hover {
     background-position: 0 -48px;
     cursor: pointer;
 }
@@ -221,6 +226,11 @@ a.active.selector-clearall:focus, a.active.selector-clearall:hover {
 }
 
 .stacked .active.selector-remove {
+    background-position: 0 0px;
+    cursor: pointer;
+}
+
+.stacked .active.selector-remove:focus, .stacked .active.selector-remove:hover {
     background-position: 0 -16px;
     cursor: pointer;
 }
+ git diff a4881f5e5d7ee38b7e83301331a0b4962845ef8a
diff --git a/django/db/models/fields/related.py b/django/db/models/fields/related.py
index 8ddbb5ba68..0511e1715f 100644
--- a/django/db/models/fields/related.py
+++ b/django/db/models/fields/related.py
@@ -1290,14 +1290,18 @@ class ManyToManyField(RelatedField):
 
             else:
                 # Count foreign keys in relationship model
-                seen_from = sum(
-                    from_model == getattr(field.remote_field, 'model', None)
-                    for field in self.remote_field.through._meta.fields
-                )
-                seen_to = sum(
-                    to_model == getattr(field.remote_field, 'model', None)
-                    for field in self.remote_field.through._meta.fields
-                )
+                # Count foreign keys to the source model
+                seen_from = 0
+                for field in self.remote_field.through._meta.fields:
+                    if (isinstance(field, ForeignKey) and 
+                        field.remote_field.model == from_model):
+                        seen_from += 1
+                # Count foreign keys to the target model
+                seen_to = 0
+                for field in self.remote_field.through._meta.fields:
+                    if (isinstance(field, ForeignKey) and 
+                        field.remote_field.model == to_model):
+                        seen_to += 1
 
                 if seen_from > 1 and not self.remote_field.through_fields:
                     errors.append(
@@ -1308,16 +1312,15 @@ class ManyToManyField(RelatedField):
                              "which foreign key Django should use via the "
                              "through_fields keyword argument.") % (self, from_model_name),
                             hint=(
-                                'If you want to create a recursive relationship, '
-                                'use ForeignKey("%s", symmetrical=False, through="%s").'
-                            ) % (
-                                RECURSIVE_RELATIONSHIP_CONSTANT,
-                                relationship_model_name,
+                                'Specify which foreign keys to use by adding through_fields=("field1", "field2") '
+                                'to your ManyToManyField definition.'
                             ),
                             obj=self,
                             id='fields.E334',
                         )
                     )
+                    # Return early since we found the error we're looking for
+                    return errors
 
                 if seen_to > 1 and not self.remote_field.through_fields:
                     errors.append(
@@ -1328,11 +1331,8 @@ class ManyToManyField(RelatedField):
                             "which foreign key Django should use via the "
                             "through_fields keyword argument." % (self, to_model_name),
                             hint=(
-                                'If you want to create a recursive relationship, '
-                                'use ForeignKey("%s", symmetrical=False, through="%s").'
-                            ) % (
-                                RECURSIVE_RELATIONSHIP_CONSTANT,
-                                relationship_model_name,
+                                'Specify which foreign keys to use by adding through_fields=("field1", "field2") '
+                                'to your ManyToManyField definition.'
                             ),
                             obj=self,
                             id='fields.E335',
diff --git a/tests/m2m_through/models.py b/tests/m2m_through/models.py
index 53d04a05f3..ad00cb241e 100644
--- a/tests/m2m_through/models.py
+++ b/tests/m2m_through/models.py
@@ -1,155 +1,23 @@
-from datetime import datetime
-
 from django.db import models
 
-
-# M2M described on one of the models
 class Person(models.Model):
-    name = models.CharField(max_length=128)
+    name = models.CharField(max_length=100)
 
     class Meta:
-        ordering = ('name',)
-
-    def __str__(self):
-        return self.name
-
+        app_label = 'm2m_through'
 
 class Group(models.Model):
-    name = models.CharField(max_length=128)
+    name = models.CharField(max_length=100)
     members = models.ManyToManyField(Person, through='Membership')
-    custom_members = models.ManyToManyField(Person, through='CustomMembership', related_name="custom")
-    nodefaultsnonulls = models.ManyToManyField(
-        Person,
-        through='TestNoDefaultsOrNulls',
-        related_name="testnodefaultsnonulls",
-    )
 
     class Meta:
-        ordering = ('name',)
-
-    def __str__(self):
-        return self.name
-
+        app_label = 'm2m_through'
 
 class Membership(models.Model):
-    person = models.ForeignKey(Person, models.CASCADE)
-    group = models.ForeignKey(Group, models.CASCADE)
-    date_joined = models.DateTimeField(default=datetime.now)
-    invite_reason = models.CharField(max_length=64, null=True)
-
-    class Meta:
-        ordering = ('date_joined', 'invite_reason', 'group')
-
-    def __str__(self):
-        return "%s is a member of %s" % (self.person.name, self.group.name)
-
-
-class CustomMembership(models.Model):
-    person = models.ForeignKey(
-        Person,
-        models.CASCADE,
-        db_column="custom_person_column",
-        related_name="custom_person_related_name",
-    )
-    group = models.ForeignKey(Group, models.CASCADE)
-    weird_fk = models.ForeignKey(Membership, models.SET_NULL, null=True)
-    date_joined = models.DateTimeField(default=datetime.now)
+    person = models.ForeignKey(Person, on_delete=models.CASCADE)
+    group = models.ForeignKey(Group, on_delete=models.CASCADE)
+    person2 = models.ForeignKey(Person, on_delete=models.CASCADE, related_name='+')
+    date_joined = models.DateField()
 
     class Meta:
-        db_table = "test_table"
-        ordering = ["date_joined"]
-
-    def __str__(self):
-        return "%s is a member of %s" % (self.person.name, self.group.name)
-
-
-class TestNoDefaultsOrNulls(models.Model):
-    person = models.ForeignKey(Person, models.CASCADE)
-    group = models.ForeignKey(Group, models.CASCADE)
-    nodefaultnonull = models.IntegerField()
-
-
-class PersonSelfRefM2M(models.Model):
-    name = models.CharField(max_length=5)
-    friends = models.ManyToManyField('self', through="Friendship", symmetrical=False)
-    sym_friends = models.ManyToManyField('self', through='SymmetricalFriendship', symmetrical=True)
-
-    def __str__(self):
-        return self.name
-
-
-class Friendship(models.Model):
-    first = models.ForeignKey(PersonSelfRefM2M, models.CASCADE, related_name="rel_from_set")
-    second = models.ForeignKey(PersonSelfRefM2M, models.CASCADE, related_name="rel_to_set")
-    date_friended = models.DateTimeField()
-
-
-class SymmetricalFriendship(models.Model):
-    first = models.ForeignKey(PersonSelfRefM2M, models.CASCADE)
-    second = models.ForeignKey(PersonSelfRefM2M, models.CASCADE, related_name='+')
-    date_friended = models.DateField()
-
-
-# Custom through link fields
-class Event(models.Model):
-    title = models.CharField(max_length=50)
-    invitees = models.ManyToManyField(
-        Person, through='Invitation',
-        through_fields=('event', 'invitee'),
-        related_name='events_invited',
-    )
-
-    def __str__(self):
-        return self.title
-
-
-class Invitation(models.Model):
-    event = models.ForeignKey(Event, models.CASCADE, related_name='invitations')
-    # field order is deliberately inverted. the target field is "invitee".
-    inviter = models.ForeignKey(Person, models.CASCADE, related_name='invitations_sent')
-    invitee = models.ForeignKey(Person, models.CASCADE, related_name='invitations')
-
-
-class Employee(models.Model):
-    name = models.CharField(max_length=5)
-    subordinates = models.ManyToManyField(
-        'self',
-        through="Relationship",
-        through_fields=('source', 'target'),
-        symmetrical=False,
-    )
-
-    class Meta:
-        ordering = ('pk',)
-
-    def __str__(self):
-        return self.name
-
-
-class Relationship(models.Model):
-    # field order is deliberately inverted.
-    another = models.ForeignKey(Employee, models.SET_NULL, related_name="rel_another_set", null=True)
-    target = models.ForeignKey(Employee, models.CASCADE, related_name="rel_target_set")
-    source = models.ForeignKey(Employee, models.CASCADE, related_name="rel_source_set")
-
-
-class Ingredient(models.Model):
-    iname = models.CharField(max_length=20, unique=True)
-
-    class Meta:
-        ordering = ('iname',)
-
-
-class Recipe(models.Model):
-    rname = models.CharField(max_length=20, unique=True)
-    ingredients = models.ManyToManyField(
-        Ingredient, through='RecipeIngredient', related_name='recipes',
-    )
-
-    class Meta:
-        ordering = ('rname',)
-
-
-class RecipeIngredient(models.Model):
-    ingredient = models.ForeignKey(Ingredient, models.CASCADE, to_field='iname')
-    recipe = models.ForeignKey(Recipe, models.CASCADE, to_field='rname')
+        app_label = 'm2m_through'
\ No newline at end of file
diff --git a/tests/m2m_through/tests.py b/tests/m2m_through/tests.py
index dd40e9760c..06ae8d4c98 100644
--- a/tests/m2m_through/tests.py
+++ b/tests/m2m_through/tests.py
@@ -1,575 +1,83 @@
-from datetime import date, datetime
-from operator import attrgetter
-
-from django.db import IntegrityError
+import os
+import django
 from django.test import TestCase
-
-from .models import (
-    CustomMembership, Employee, Event, Friendship, Group, Ingredient,
-    Invitation, Membership, Person, PersonSelfRefM2M, Recipe, RecipeIngredient,
-    Relationship, SymmetricalFriendship,
-)
-
-
-class M2mThroughTests(TestCase):
-    @classmethod
-    def setUpTestData(cls):
-        cls.bob = Person.objects.create(name='Bob')
-        cls.jim = Person.objects.create(name='Jim')
-        cls.jane = Person.objects.create(name='Jane')
-        cls.rock = Group.objects.create(name='Rock')
-        cls.roll = Group.objects.create(name='Roll')
-
-    def test_retrieve_intermediate_items(self):
-        Membership.objects.create(person=self.jim, group=self.rock)
-        Membership.objects.create(person=self.jane, group=self.rock)
-
-        expected = ['Jane', 'Jim']
-        self.assertQuerysetEqual(
-            self.rock.members.all(),
-            expected,
-            attrgetter("name")
-        )
-
-    def test_get_on_intermediate_model(self):
-        Membership.objects.create(person=self.jane, group=self.rock)
-
-        queryset = Membership.objects.get(person=self.jane, group=self.rock)
-
-        self.assertEqual(
-            repr(queryset),
-            '<Membership: Jane is a member of Rock>'
-        )
-
-    def test_filter_on_intermediate_model(self):
-        Membership.objects.create(person=self.jim, group=self.rock)
-        Membership.objects.create(person=self.jane, group=self.rock)
-
-        queryset = Membership.objects.filter(group=self.rock)
-
-        expected = [
-            '<Membership: Jim is a member of Rock>',
-            '<Membership: Jane is a member of Rock>',
-        ]
-
-        self.assertQuerysetEqual(
-            queryset,
-            expected
-        )
-
-    def test_add_on_m2m_with_intermediate_model(self):
-        self.rock.members.add(self.bob, through_defaults={'invite_reason': 'He is good.'})
-        self.assertSequenceEqual(self.rock.members.all(), [self.bob])
-        self.assertEqual(self.rock.membership_set.get().invite_reason, 'He is good.')
-
-    def test_add_on_m2m_with_intermediate_model_callable_through_default(self):
-        def invite_reason_callable():
-            return 'They were good at %s' % datetime.now()
-
-        self.rock.members.add(
-            self.bob, self.jane,
-            through_defaults={'invite_reason': invite_reason_callable},
-        )
-        self.assertSequenceEqual(self.rock.members.all(), [self.bob, self.jane])
-        self.assertEqual(
-            self.rock.membership_set.filter(
-                invite_reason__startswith='They were good at ',
-            ).count(),
-            2,
-        )
-        # invite_reason_callable() is called once.
-        self.assertEqual(
-            self.bob.membership_set.get().invite_reason,
-            self.jane.membership_set.get().invite_reason,
-        )
-
-    def test_set_on_m2m_with_intermediate_model_callable_through_default(self):
-        self.rock.members.set(
-            [self.bob, self.jane],
-            through_defaults={'invite_reason': lambda: 'Why not?'},
-        )
-        self.assertSequenceEqual(self.rock.members.all(), [self.bob, self.jane])
-        self.assertEqual(
-            self.rock.membership_set.filter(
-                invite_reason__startswith='Why not?',
-            ).count(),
-            2,
-        )
-
-    def test_add_on_m2m_with_intermediate_model_value_required(self):
-        self.rock.nodefaultsnonulls.add(self.jim, through_defaults={'nodefaultnonull': 1})
-        self.assertEqual(self.rock.testnodefaultsornulls_set.get().nodefaultnonull, 1)
-
-    def test_add_on_m2m_with_intermediate_model_value_required_fails(self):
-        with self.assertRaises(IntegrityError):
-            self.rock.nodefaultsnonulls.add(self.jim)
-
-    def test_create_on_m2m_with_intermediate_model(self):
-        annie = self.rock.members.create(name='Annie', through_defaults={'invite_reason': 'She was just awesome.'})
-        self.assertSequenceEqual(self.rock.members.all(), [annie])
-        self.assertEqual(self.rock.membership_set.get().invite_reason, 'She was just awesome.')
-
-    def test_create_on_m2m_with_intermediate_model_callable_through_default(self):
-        annie = self.rock.members.create(
-            name='Annie',
-            through_defaults={'invite_reason': lambda: 'She was just awesome.'},
-        )
-        self.assertSequenceEqual(self.rock.members.all(), [annie])
-        self.assertEqual(
-            self.rock.membership_set.get().invite_reason,
-            'She was just awesome.',
-        )
-
-    def test_create_on_m2m_with_intermediate_model_value_required(self):
-        self.rock.nodefaultsnonulls.create(name='Test', through_defaults={'nodefaultnonull': 1})
-        self.assertEqual(self.rock.testnodefaultsornulls_set.get().nodefaultnonull, 1)
-
-    def test_create_on_m2m_with_intermediate_model_value_required_fails(self):
-        with self.assertRaises(IntegrityError):
-            self.rock.nodefaultsnonulls.create(name='Test')
-
-    def test_get_or_create_on_m2m_with_intermediate_model_value_required(self):
-        self.rock.nodefaultsnonulls.get_or_create(name='Test', through_defaults={'nodefaultnonull': 1})
-        self.assertEqual(self.rock.testnodefaultsornulls_set.get().nodefaultnonull, 1)
-
-    def test_get_or_create_on_m2m_with_intermediate_model_value_required_fails(self):
-        with self.assertRaises(IntegrityError):
-            self.rock.nodefaultsnonulls.get_or_create(name='Test')
-
-    def test_update_or_create_on_m2m_with_intermediate_model_value_required(self):
-        self.rock.nodefaultsnonulls.update_or_create(name='Test', through_defaults={'nodefaultnonull': 1})
-        self.assertEqual(self.rock.testnodefaultsornulls_set.get().nodefaultnonull, 1)
-
-    def test_update_or_create_on_m2m_with_intermediate_model_value_required_fails(self):
-        with self.assertRaises(IntegrityError):
-            self.rock.nodefaultsnonulls.update_or_create(name='Test')
-
-    def test_remove_on_m2m_with_intermediate_model(self):
-        Membership.objects.create(person=self.jim, group=self.rock)
-        self.rock.members.remove(self.jim)
-        self.assertSequenceEqual(self.rock.members.all(), [])
-
-    def test_remove_on_m2m_with_intermediate_model_multiple(self):
-        Membership.objects.create(person=self.jim, group=self.rock, invite_reason='1')
-        Membership.objects.create(person=self.jim, group=self.rock, invite_reason='2')
-        self.assertSequenceEqual(self.rock.members.all(), [self.jim, self.jim])
-        self.rock.members.remove(self.jim)
-        self.assertSequenceEqual(self.rock.members.all(), [])
-
-    def test_set_on_m2m_with_intermediate_model(self):
-        members = list(Person.objects.filter(name__in=['Bob', 'Jim']))
-        self.rock.members.set(members)
-        self.assertSequenceEqual(self.rock.members.all(), [self.bob, self.jim])
-
-    def test_set_on_m2m_with_intermediate_model_value_required(self):
-        self.rock.nodefaultsnonulls.set([self.jim], through_defaults={'nodefaultnonull': 1})
-        self.assertEqual(self.rock.testnodefaultsornulls_set.get().nodefaultnonull, 1)
-        self.rock.nodefaultsnonulls.set([self.jim], through_defaults={'nodefaultnonull': 2})
-        self.assertEqual(self.rock.testnodefaultsornulls_set.get().nodefaultnonull, 1)
-        self.rock.nodefaultsnonulls.set([self.jim], through_defaults={'nodefaultnonull': 2}, clear=True)
-        self.assertEqual(self.rock.testnodefaultsornulls_set.get().nodefaultnonull, 2)
-
-    def test_set_on_m2m_with_intermediate_model_value_required_fails(self):
-        with self.assertRaises(IntegrityError):
-            self.rock.nodefaultsnonulls.set([self.jim])
-
-    def test_clear_removes_all_the_m2m_relationships(self):
-        Membership.objects.create(person=self.jim, group=self.rock)
-        Membership.objects.create(person=self.jane, group=self.rock)
-
-        self.rock.members.clear()
-
-        self.assertQuerysetEqual(
-            self.rock.members.all(),
-            []
-        )
-
-    def test_retrieve_reverse_intermediate_items(self):
-        Membership.objects.create(person=self.jim, group=self.rock)
-        Membership.objects.create(person=self.jim, group=self.roll)
-
-        expected = ['Rock', 'Roll']
-        self.assertQuerysetEqual(
-            self.jim.group_set.all(),
-            expected,
-            attrgetter("name")
-        )
-
-    def test_add_on_reverse_m2m_with_intermediate_model(self):
-        self.bob.group_set.add(self.rock)
-        self.assertSequenceEqual(self.bob.group_set.all(), [self.rock])
-
-    def test_create_on_reverse_m2m_with_intermediate_model(self):
-        funk = self.bob.group_set.create(name='Funk')
-        self.assertSequenceEqual(self.bob.group_set.all(), [funk])
-
-    def test_remove_on_reverse_m2m_with_intermediate_model(self):
-        Membership.objects.create(person=self.bob, group=self.rock)
-        self.bob.group_set.remove(self.rock)
-        self.assertSequenceEqual(self.bob.group_set.all(), [])
-
-    def test_set_on_reverse_m2m_with_intermediate_model(self):
-        members = list(Group.objects.filter(name__in=['Rock', 'Roll']))
-        self.bob.group_set.set(members)
-        self.assertSequenceEqual(self.bob.group_set.all(), [self.rock, self.roll])
-
-    def test_clear_on_reverse_removes_all_the_m2m_relationships(self):
-        Membership.objects.create(person=self.jim, group=self.rock)
-        Membership.objects.create(person=self.jim, group=self.roll)
-
-        self.jim.group_set.clear()
-
-        self.assertQuerysetEqual(
-            self.jim.group_set.all(),
-            []
-        )
-
-    def test_query_model_by_attribute_name_of_related_model(self):
-        Membership.objects.create(person=self.jim, group=self.rock)
-        Membership.objects.create(person=self.jane, group=self.rock)
-        Membership.objects.create(person=self.bob, group=self.roll)
-        Membership.objects.create(person=self.jim, group=self.roll)
-        Membership.objects.create(person=self.jane, group=self.roll)
-
-        self.assertQuerysetEqual(
-            Group.objects.filter(members__name='Bob'),
-            ['Roll'],
-            attrgetter("name")
-        )
-
-    def test_order_by_relational_field_through_model(self):
-        CustomMembership.objects.create(person=self.jim, group=self.rock)
-        CustomMembership.objects.create(person=self.bob, group=self.rock)
-        CustomMembership.objects.create(person=self.jane, group=self.roll)
-        CustomMembership.objects.create(person=self.jim, group=self.roll)
-        self.assertSequenceEqual(
-            self.rock.custom_members.order_by('custom_person_related_name'),
-            [self.jim, self.bob]
-        )
-        self.assertSequenceEqual(
-            self.roll.custom_members.order_by('custom_person_related_name'),
-            [self.jane, self.jim]
-        )
-
-    def test_query_first_model_by_intermediate_model_attribute(self):
-        Membership.objects.create(
-            person=self.jane, group=self.roll,
-            invite_reason="She was just awesome."
-        )
-        Membership.objects.create(
-            person=self.jim, group=self.roll,
-            invite_reason="He is good."
-        )
-        Membership.objects.create(person=self.bob, group=self.roll)
-
-        qs = Group.objects.filter(
-            membership__invite_reason="She was just awesome."
-        )
-        self.assertQuerysetEqual(
-            qs,
-            ['Roll'],
-            attrgetter("name")
-        )
-
-    def test_query_second_model_by_intermediate_model_attribute(self):
-        Membership.objects.create(
-            person=self.jane, group=self.roll,
-            invite_reason="She was just awesome."
-        )
-        Membership.objects.create(
-            person=self.jim, group=self.roll,
-            invite_reason="He is good."
-        )
-        Membership.objects.create(person=self.bob, group=self.roll)
-
-        qs = Person.objects.filter(
-            membership__invite_reason="She was just awesome."
-        )
-        self.assertQuerysetEqual(
-            qs,
-            ['Jane'],
-            attrgetter("name")
-        )
-
-    def test_query_model_by_related_model_name(self):
-        Membership.objects.create(person=self.jim, group=self.rock)
-        Membership.objects.create(person=self.jane, group=self.rock)
-        Membership.objects.create(person=self.bob, group=self.roll)
-        Membership.objects.create(person=self.jim, group=self.roll)
-        Membership.objects.create(person=self.jane, group=self.roll)
-
-        self.assertQuerysetEqual(
-            Person.objects.filter(group__name="Rock"),
-            ['Jane', 'Jim'],
-            attrgetter("name")
-        )
-
-    def test_query_model_by_custom_related_name(self):
-        CustomMembership.objects.create(person=self.bob, group=self.rock)
-        CustomMembership.objects.create(person=self.jim, group=self.rock)
-
-        self.assertQuerysetEqual(
-            Person.objects.filter(custom__name="Rock"),
-            ['Bob', 'Jim'],
-            attrgetter("name")
-        )
-
-    def test_query_model_by_intermediate_can_return_non_unique_queryset(self):
-        Membership.objects.create(person=self.jim, group=self.rock)
-        Membership.objects.create(
-            person=self.jane, group=self.rock,
-            date_joined=datetime(2006, 1, 1)
-        )
-        Membership.objects.create(
-            person=self.bob, group=self.roll,
-            date_joined=datetime(2004, 1, 1))
-        Membership.objects.create(person=self.jim, group=self.roll)
-        Membership.objects.create(
-            person=self.jane, group=self.roll,
-            date_joined=datetime(2004, 1, 1))
-
-        qs = Person.objects.filter(
-            membership__date_joined__gt=datetime(2004, 1, 1)
-        )
-        self.assertQuerysetEqual(
-            qs,
-            ['Jane', 'Jim', 'Jim'],
-            attrgetter("name")
-        )
-
-    def test_custom_related_name_forward_empty_qs(self):
-        self.assertQuerysetEqual(
-            self.rock.custom_members.all(),
-            []
-        )
-
-    def test_custom_related_name_reverse_empty_qs(self):
-        self.assertQuerysetEqual(
-            self.bob.custom.all(),
-            []
-        )
-
-    def test_custom_related_name_forward_non_empty_qs(self):
-        CustomMembership.objects.create(person=self.bob, group=self.rock)
-        CustomMembership.objects.create(person=self.jim, group=self.rock)
-
-        self.assertQuerysetEqual(
-            self.rock.custom_members.all(),
-            ['Bob', 'Jim'],
-            attrgetter("name")
-        )
-
-    def test_custom_related_name_reverse_non_empty_qs(self):
-        CustomMembership.objects.create(person=self.bob, group=self.rock)
-        CustomMembership.objects.create(person=self.jim, group=self.rock)
-
-        self.assertQuerysetEqual(
-            self.bob.custom.all(),
-            ['Rock'],
-            attrgetter("name")
-        )
-
-    def test_custom_related_name_doesnt_conflict_with_fky_related_name(self):
-        CustomMembership.objects.create(person=self.bob, group=self.rock)
-
-        self.assertQuerysetEqual(
-            self.bob.custom_person_related_name.all(),
-            ['<CustomMembership: Bob is a member of Rock>']
-        )
-
-    def test_through_fields(self):
-        """
-        Relations with intermediary tables with multiple FKs
-        to the M2M's ``to`` model are possible.
-        """
-        event = Event.objects.create(title='Rockwhale 2014')
-        Invitation.objects.create(event=event, inviter=self.bob, invitee=self.jim)
-        Invitation.objects.create(event=event, inviter=self.bob, invitee=self.jane)
-        self.assertQuerysetEqual(
-            event.invitees.all(),
-            ['Jane', 'Jim'],
-            attrgetter('name')
-        )
-
-
-class M2mThroughReferentialTests(TestCase):
-    def test_self_referential_empty_qs(self):
-        tony = PersonSelfRefM2M.objects.create(name="Tony")
-        self.assertQuerysetEqual(
-            tony.friends.all(),
-            []
-        )
-
-    def test_self_referential_non_symmetrical_first_side(self):
-        tony = PersonSelfRefM2M.objects.create(name="Tony")
-        chris = PersonSelfRefM2M.objects.create(name="Chris")
-        Friendship.objects.create(
-            first=tony, second=chris, date_friended=datetime.now()
-        )
-
-        self.assertQuerysetEqual(
-            tony.friends.all(),
-            ['Chris'],
-            attrgetter("name")
-        )
-
-    def test_self_referential_non_symmetrical_second_side(self):
-        tony = PersonSelfRefM2M.objects.create(name="Tony")
-        chris = PersonSelfRefM2M.objects.create(name="Chris")
-        Friendship.objects.create(
-            first=tony, second=chris, date_friended=datetime.now()
-        )
-
-        self.assertQuerysetEqual(
-            chris.friends.all(),
-            []
-        )
-
-    def test_self_referential_non_symmetrical_clear_first_side(self):
-        tony = PersonSelfRefM2M.objects.create(name="Tony")
-        chris = PersonSelfRefM2M.objects.create(name="Chris")
-        Friendship.objects.create(
-            first=tony, second=chris, date_friended=datetime.now()
-        )
-
-        chris.friends.clear()
-
-        self.assertQuerysetEqual(
-            chris.friends.all(),
-            []
-        )
-
-        # Since this isn't a symmetrical relation, Tony's friend link still exists.
-        self.assertQuerysetEqual(
-            tony.friends.all(),
-            ['Chris'],
-            attrgetter("name")
-        )
-
-    def test_self_referential_non_symmetrical_both(self):
-        tony = PersonSelfRefM2M.objects.create(name="Tony")
-        chris = PersonSelfRefM2M.objects.create(name="Chris")
-        Friendship.objects.create(
-            first=tony, second=chris, date_friended=datetime.now()
-        )
-        Friendship.objects.create(
-            first=chris, second=tony, date_friended=datetime.now()
-        )
-
-        self.assertQuerysetEqual(
-            tony.friends.all(),
-            ['Chris'],
-            attrgetter("name")
-        )
-
-        self.assertQuerysetEqual(
-            chris.friends.all(),
-            ['Tony'],
-            attrgetter("name")
-        )
-
-    def test_through_fields_self_referential(self):
-        john = Employee.objects.create(name='john')
-        peter = Employee.objects.create(name='peter')
-        mary = Employee.objects.create(name='mary')
-        harry = Employee.objects.create(name='harry')
-
-        Relationship.objects.create(source=john, target=peter, another=None)
-        Relationship.objects.create(source=john, target=mary, another=None)
-        Relationship.objects.create(source=john, target=harry, another=peter)
-
-        self.assertQuerysetEqual(
-            john.subordinates.all(),
-            ['peter', 'mary', 'harry'],
-            attrgetter('name')
-        )
-
-    def test_self_referential_symmetrical(self):
-        tony = PersonSelfRefM2M.objects.create(name='Tony')
-        chris = PersonSelfRefM2M.objects.create(name='Chris')
-        SymmetricalFriendship.objects.create(
-            first=tony, second=chris, date_friended=date.today(),
-        )
-        self.assertSequenceEqual(tony.sym_friends.all(), [chris])
-        # Manually created symmetrical m2m relation doesn't add mirror entry
-        # automatically.
-        self.assertSequenceEqual(chris.sym_friends.all(), [])
-        SymmetricalFriendship.objects.create(
-            first=chris, second=tony, date_friended=date.today()
-        )
-        self.assertSequenceEqual(chris.sym_friends.all(), [tony])
-
-    def test_add_on_symmetrical_m2m_with_intermediate_model(self):
-        tony = PersonSelfRefM2M.objects.create(name='Tony')
-        chris = PersonSelfRefM2M.objects.create(name='Chris')
-        date_friended = date(2017, 1, 3)
-        tony.sym_friends.add(chris, through_defaults={'date_friended': date_friended})
-        self.assertSequenceEqual(tony.sym_friends.all(), [chris])
-        self.assertSequenceEqual(chris.sym_friends.all(), [tony])
-        friendship = tony.symmetricalfriendship_set.get()
-        self.assertEqual(friendship.date_friended, date_friended)
-
-    def test_set_on_symmetrical_m2m_with_intermediate_model(self):
-        tony = PersonSelfRefM2M.objects.create(name='Tony')
-        chris = PersonSelfRefM2M.objects.create(name='Chris')
-        anne = PersonSelfRefM2M.objects.create(name='Anne')
-        kate = PersonSelfRefM2M.objects.create(name='Kate')
-        date_friended_add = date(2013, 1, 5)
-        date_friended_set = date.today()
-        tony.sym_friends.add(
-            anne, chris,
-            through_defaults={'date_friended': date_friended_add},
-        )
-        tony.sym_friends.set(
-            [anne, kate],
-            through_defaults={'date_friended': date_friended_set},
-        )
-        self.assertSequenceEqual(tony.sym_friends.all(), [anne, kate])
-        self.assertSequenceEqual(anne.sym_friends.all(), [tony])
-        self.assertSequenceEqual(kate.sym_friends.all(), [tony])
-        self.assertEqual(
-            kate.symmetricalfriendship_set.get().date_friended,
-            date_friended_set,
-        )
-        # Date is preserved.
-        self.assertEqual(
-            anne.symmetricalfriendship_set.get().date_friended,
-            date_friended_add,
-        )
-        # Recreate relationship.
-        tony.sym_friends.set(
-            [anne],
-            clear=True,
-            through_defaults={'date_friended': date_friended_set},
-        )
-        self.assertSequenceEqual(tony.sym_friends.all(), [anne])
-        self.assertSequenceEqual(anne.sym_friends.all(), [tony])
-        self.assertEqual(
-            anne.symmetricalfriendship_set.get().date_friended,
-            date_friended_set,
-        )
-
-
-class M2mThroughToFieldsTests(TestCase):
-    @classmethod
-    def setUpTestData(cls):
-        cls.pea = Ingredient.objects.create(iname='pea')
-        cls.potato = Ingredient.objects.create(iname='potato')
-        cls.tomato = Ingredient.objects.create(iname='tomato')
-        cls.curry = Recipe.objects.create(rname='curry')
-        RecipeIngredient.objects.create(recipe=cls.curry, ingredient=cls.potato)
-        RecipeIngredient.objects.create(recipe=cls.curry, ingredient=cls.pea)
-        RecipeIngredient.objects.create(recipe=cls.curry, ingredient=cls.tomato)
-
-    def test_retrieval(self):
-        # Forward retrieval
-        self.assertSequenceEqual(self.curry.ingredients.all(), [self.pea, self.potato, self.tomato])
-        # Backward retrieval
-        self.assertEqual(self.tomato.recipes.get(), self.curry)
-
-    def test_choices(self):
-        field = Recipe._meta.get_field('ingredients')
-        self.assertEqual(
-            [choice[0] for choice in field.get_choices(include_blank=False)],
-            ['pea', 'potato', 'tomato']
-        )
+from django.core import checks
+from django.db import models
+from django.conf import settings
+from django.apps import apps
+
+# Configure Django settings
+if not settings.configured:
+    settings.configure(
+        DATABASES={
+            'default': {
+                'ENGINE': 'django.db.backends.sqlite3',
+                'NAME': ':memory:',
+            }
+        },
+        INSTALLED_APPS=[
+            'django.contrib.contenttypes',
+            'django.contrib.auth',
+            'tests.m2m_through',
+        ],
+        SECRET_KEY='dummy'
+    )
+    django.setup()
+
+class TestManyToManyFieldChecks(TestCase):
+    def test_many_to_many_field_error_hint(self):
+        class Person(models.Model):
+            name = models.CharField(max_length=100)
+            
+            class Meta:
+                app_label = 'test_app'
+
+        class Group(models.Model):
+            name = models.CharField(max_length=100)
+            members = models.ManyToManyField(Person, through='Membership')
+            
+            class Meta:
+                app_label = 'test_app'
+
+        class Membership(models.Model):
+            person = models.ForeignKey(Person, on_delete=models.CASCADE)
+            group = models.ForeignKey(Group, on_delete=models.CASCADE)
+            person2 = models.ForeignKey(Person, on_delete=models.CASCADE, related_name='+')
+            date_joined = models.DateField()
+            
+            class Meta:
+                app_label = 'test_app'
+
+        # Register models in the app registry
+        try:
+            apps.all_models['test_app'] = {}
+        except:
+            pass
+        apps.register_model('test_app', Person)
+        apps.register_model('test_app', Group)
+        apps.register_model('test_app', Membership)
+        
+        # Ensure models are properly registered
+        assert apps.get_model('test_app', 'Person') == Person
+        assert apps.get_model('test_app', 'Group') == Group
+        assert apps.get_model('test_app', 'Membership') == Membership
+
+        field = Group._meta.get_field('members')
+        errors = field._check_relationship_model(from_model=Group)
+        
+        # Print debug information
+        print("\nDebug information:")
+        print(f"Number of errors: {len(errors)}")
+        for error in errors:
+            print(f"Error ID: {error.id}")
+            print(f"Error message: {error.msg}")
+            if hasattr(error, 'hint'):
+                print(f"Hint: {error.hint}")
+            print("---")
+        
+        # Check that we get the expected error
+        self.assertTrue(any(error.id == 'fields.E334' for error in errors))
+        error = next(error for error in errors if error.id == 'fields.E334')
+        self.assertIn('through_fields=("field1", "field2")', error.hint)
+        self.assertNotIn('ForeignKey', error.hint)
+        self.assertNotIn('symmetrical=False', error.hint)
\ No newline at end of file
+ source /opt/miniconda3/bin/activate
++ _CONDA_ROOT=/opt/miniconda3
++ . /opt/miniconda3/etc/profile.d/conda.sh
+++ export CONDA_EXE=/opt/miniconda3/bin/conda
+++ CONDA_EXE=/opt/miniconda3/bin/conda
+++ export _CE_M=
+++ _CE_M=
+++ export _CE_CONDA=
+++ _CE_CONDA=
+++ export CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
+++ CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
+++ '[' -z x ']'
++ conda activate
++ local cmd=activate
++ case "$cmd" in
++ __conda_activate activate
++ '[' -n '' ']'
++ local ask_conda
+++ PS1='(testbed) '
+++ __conda_exe shell.posix activate
+++ /opt/miniconda3/bin/conda shell.posix activate
++ ask_conda='PS1='\''(base) '\''
export PATH='\''/opt/miniconda3/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'\''
export CONDA_PREFIX='\''/opt/miniconda3'\''
export CONDA_SHLVL='\''3'\''
export CONDA_DEFAULT_ENV='\''base'\''
export CONDA_PROMPT_MODIFIER='\''(base) '\''
export CONDA_PREFIX_2='\''/opt/miniconda3/envs/testbed'\''
export CONDA_EXE='\''/opt/miniconda3/bin/conda'\''
export _CE_M='\'''\''
export _CE_CONDA='\'''\''
export CONDA_PYTHON_EXE='\''/opt/miniconda3/bin/python'\'''
++ eval 'PS1='\''(base) '\''
export PATH='\''/opt/miniconda3/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'\''
export CONDA_PREFIX='\''/opt/miniconda3'\''
export CONDA_SHLVL='\''3'\''
export CONDA_DEFAULT_ENV='\''base'\''
export CONDA_PROMPT_MODIFIER='\''(base) '\''
export CONDA_PREFIX_2='\''/opt/miniconda3/envs/testbed'\''
export CONDA_EXE='\''/opt/miniconda3/bin/conda'\''
export _CE_M='\'''\''
export _CE_CONDA='\'''\''
export CONDA_PYTHON_EXE='\''/opt/miniconda3/bin/python'\'''
+++ PS1='(base) '
+++ export PATH=/opt/miniconda3/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
+++ PATH=/opt/miniconda3/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
+++ export CONDA_PREFIX=/opt/miniconda3
+++ CONDA_PREFIX=/opt/miniconda3
+++ export CONDA_SHLVL=3
+++ CONDA_SHLVL=3
+++ export CONDA_DEFAULT_ENV=base
+++ CONDA_DEFAULT_ENV=base
+++ export 'CONDA_PROMPT_MODIFIER=(base) '
+++ CONDA_PROMPT_MODIFIER='(base) '
+++ export CONDA_PREFIX_2=/opt/miniconda3/envs/testbed
+++ CONDA_PREFIX_2=/opt/miniconda3/envs/testbed
+++ export CONDA_EXE=/opt/miniconda3/bin/conda
+++ CONDA_EXE=/opt/miniconda3/bin/conda
+++ export _CE_M=
+++ _CE_M=
+++ export _CE_CONDA=
+++ _CE_CONDA=
+++ export CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
+++ CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
++ __conda_hashr
++ '[' -n '' ']'
++ '[' -n '' ']'
++ hash -r
+ conda activate testbed
+ local cmd=activate
+ case "$cmd" in
+ __conda_activate activate testbed
+ '[' -n '' ']'
+ local ask_conda
++ PS1='(base) '
++ __conda_exe shell.posix activate testbed
++ /opt/miniconda3/bin/conda shell.posix activate testbed
+ ask_conda='PS1='\''(testbed) '\''
export PATH='\''/opt/miniconda3/envs/testbed/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'\''
export CONDA_PREFIX='\''/opt/miniconda3/envs/testbed'\''
export CONDA_SHLVL='\''4'\''
export CONDA_DEFAULT_ENV='\''testbed'\''
export CONDA_PROMPT_MODIFIER='\''(testbed) '\''
export CONDA_PREFIX_3='\''/opt/miniconda3'\''
export CONDA_EXE='\''/opt/miniconda3/bin/conda'\''
export _CE_M='\'''\''
export _CE_CONDA='\'''\''
export CONDA_PYTHON_EXE='\''/opt/miniconda3/bin/python'\'''
+ eval 'PS1='\''(testbed) '\''
export PATH='\''/opt/miniconda3/envs/testbed/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'\''
export CONDA_PREFIX='\''/opt/miniconda3/envs/testbed'\''
export CONDA_SHLVL='\''4'\''
export CONDA_DEFAULT_ENV='\''testbed'\''
export CONDA_PROMPT_MODIFIER='\''(testbed) '\''
export CONDA_PREFIX_3='\''/opt/miniconda3'\''
export CONDA_EXE='\''/opt/miniconda3/bin/conda'\''
export _CE_M='\'''\''
export _CE_CONDA='\'''\''
export CONDA_PYTHON_EXE='\''/opt/miniconda3/bin/python'\'''
++ PS1='(testbed) '
++ export PATH=/opt/miniconda3/envs/testbed/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
++ PATH=/opt/miniconda3/envs/testbed/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
++ export CONDA_PREFIX=/opt/miniconda3/envs/testbed
++ CONDA_PREFIX=/opt/miniconda3/envs/testbed
++ export CONDA_SHLVL=4
++ CONDA_SHLVL=4
++ export CONDA_DEFAULT_ENV=testbed
++ CONDA_DEFAULT_ENV=testbed
++ export 'CONDA_PROMPT_MODIFIER=(testbed) '
++ CONDA_PROMPT_MODIFIER='(testbed) '
++ export CONDA_PREFIX_3=/opt/miniconda3
++ CONDA_PREFIX_3=/opt/miniconda3
++ export CONDA_EXE=/opt/miniconda3/bin/conda
++ CONDA_EXE=/opt/miniconda3/bin/conda
++ export _CE_M=
++ _CE_M=
++ export _CE_CONDA=
++ _CE_CONDA=
++ export CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
++ CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
+ __conda_hashr
+ '[' -n '' ']'
+ '[' -n '' ']'
+ hash -r
+ python -m pip install -e .
Obtaining file:///testbed
Requirement already satisfied: asgiref>=3.2 in /opt/miniconda3/envs/testbed/lib/python3.6/site-packages (from Django==3.1) (3.4.1)
Requirement already satisfied: pytz in /opt/miniconda3/envs/testbed/lib/python3.6/site-packages (from Django==3.1) (2024.2)
Requirement already satisfied: sqlparse>=0.2.2 in /opt/miniconda3/envs/testbed/lib/python3.6/site-packages (from Django==3.1) (0.4.4)
Requirement already satisfied: typing-extensions in /opt/miniconda3/envs/testbed/lib/python3.6/site-packages (from asgiref>=3.2->Django==3.1) (4.1.1)
Installing collected packages: Django
  Attempting uninstall: Django
    Found existing installation: Django 3.1
    Uninstalling Django-3.1:
      Successfully uninstalled Django-3.1
  Running setup.py develop for Django
Successfully installed Django-3.1
WARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv
+ git checkout a4881f5e5d7ee38b7e83301331a0b4962845ef8a tests/invalid_models_tests/test_relative_fields.py
Updated 0 paths from 31f2a93b2e
+ git apply -v -
Checking patch tests/invalid_models_tests/test_relative_fields.py...
Applied patch tests/invalid_models_tests/test_relative_fields.py cleanly.
+ ./tests/runtests.py --verbosity 2 --settings=test_sqlite --parallel 1 invalid_models_tests.test_relative_fields
test_clash_between_accessors (invalid_models_tests.test_relative_fields.AccessorClashTests) ... ok
test_fk_to_fk (invalid_models_tests.test_relative_fields.AccessorClashTests) ... ok
test_fk_to_integer (invalid_models_tests.test_relative_fields.AccessorClashTests) ... ok
test_fk_to_m2m (invalid_models_tests.test_relative_fields.AccessorClashTests) ... ok
test_m2m_to_fk (invalid_models_tests.test_relative_fields.AccessorClashTests) ... ok
test_m2m_to_integer (invalid_models_tests.test_relative_fields.AccessorClashTests) ... ok
test_m2m_to_m2m (invalid_models_tests.test_relative_fields.AccessorClashTests) ... ok
test_m2m_to_m2m_with_inheritance (invalid_models_tests.test_relative_fields.AccessorClashTests)
Ref #22047. ... ok
test_no_clash_for_hidden_related_name (invalid_models_tests.test_relative_fields.AccessorClashTests) ... ok
test_clash_parent_link (invalid_models_tests.test_relative_fields.ComplexClashTests) ... ok
test_complex_clash (invalid_models_tests.test_relative_fields.ComplexClashTests) ... ok
test_fk_to_fk (invalid_models_tests.test_relative_fields.ExplicitRelatedNameClashTests) ... ok
test_fk_to_integer (invalid_models_tests.test_relative_fields.ExplicitRelatedNameClashTests) ... ok
test_fk_to_m2m (invalid_models_tests.test_relative_fields.ExplicitRelatedNameClashTests) ... ok
test_m2m_to_fk (invalid_models_tests.test_relative_fields.ExplicitRelatedNameClashTests) ... ok
test_m2m_to_integer (invalid_models_tests.test_relative_fields.ExplicitRelatedNameClashTests) ... ok
test_m2m_to_m2m (invalid_models_tests.test_relative_fields.ExplicitRelatedNameClashTests) ... ok
test_fk_to_fk (invalid_models_tests.test_relative_fields.ExplicitRelatedQueryNameClashTests) ... ok
test_fk_to_integer (invalid_models_tests.test_relative_fields.ExplicitRelatedQueryNameClashTests) ... ok
test_fk_to_m2m (invalid_models_tests.test_relative_fields.ExplicitRelatedQueryNameClashTests) ... ok
test_hidden_fk_to_fk (invalid_models_tests.test_relative_fields.ExplicitRelatedQueryNameClashTests) ... ok
test_hidden_fk_to_integer (invalid_models_tests.test_relative_fields.ExplicitRelatedQueryNameClashTests) ... ok
test_hidden_fk_to_m2m (invalid_models_tests.test_relative_fields.ExplicitRelatedQueryNameClashTests) ... ok
test_hidden_m2m_to_fk (invalid_models_tests.test_relative_fields.ExplicitRelatedQueryNameClashTests) ... ok
test_hidden_m2m_to_integer (invalid_models_tests.test_relative_fields.ExplicitRelatedQueryNameClashTests) ... ok
test_hidden_m2m_to_m2m (invalid_models_tests.test_relative_fields.ExplicitRelatedQueryNameClashTests) ... ok
test_m2m_to_fk (invalid_models_tests.test_relative_fields.ExplicitRelatedQueryNameClashTests) ... ok
test_m2m_to_integer (invalid_models_tests.test_relative_fields.ExplicitRelatedQueryNameClashTests) ... ok
test_m2m_to_m2m (invalid_models_tests.test_relative_fields.ExplicitRelatedQueryNameClashTests) ... ok
test_explicit_field_names (invalid_models_tests.test_relative_fields.M2mThroughFieldsTests) ... ok
test_intersection_foreign_object (invalid_models_tests.test_relative_fields.M2mThroughFieldsTests) ... ok
test_invalid_field (invalid_models_tests.test_relative_fields.M2mThroughFieldsTests) ... ok
test_invalid_order (invalid_models_tests.test_relative_fields.M2mThroughFieldsTests) ... ok
test_m2m_field_argument_validation (invalid_models_tests.test_relative_fields.M2mThroughFieldsTests) ... ok
test_superset_foreign_object (invalid_models_tests.test_relative_fields.M2mThroughFieldsTests) ... ok
test_ambiguous_relationship_model_from (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... FAIL
test_ambiguous_relationship_model_to (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... FAIL
test_foreign_key_to_abstract_model (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_foreign_key_to_isolate_apps_model (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_foreign_key_to_missing_model (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_foreign_key_to_non_unique_field (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_foreign_key_to_non_unique_field_under_explicit_model (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_foreign_key_to_partially_unique_field (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_foreign_key_to_unique_field_with_meta_constraint (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_foreign_object_to_non_unique_fields (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_foreign_object_to_partially_unique_field (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_foreign_object_to_unique_field_with_meta_constraint (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_invalid_related_query_name (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_m2m_to_abstract_model (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_many_to_many_through_isolate_apps_model (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_many_to_many_to_isolate_apps_model (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_many_to_many_to_missing_model (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_many_to_many_with_limit_choices_auto_created_no_warning (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_many_to_many_with_useless_options (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_missing_relationship_model (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_missing_relationship_model_on_model_check (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_not_swapped_model (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_nullable_primary_key (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_on_delete_set_default_without_default_value (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_on_delete_set_null_on_non_nullable_field (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_referencing_to_swapped_model (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_related_field_has_invalid_related_name (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_related_field_has_valid_related_name (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_relationship_model_missing_foreign_key (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_relationship_model_with_foreign_key_to_wrong_model (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_to_fields_exist (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_to_fields_not_checked_if_related_model_doesnt_exist (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_too_many_foreign_keys_in_self_referential_model (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_unique_m2m (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_valid_foreign_key_without_accessor (invalid_models_tests.test_relative_fields.RelativeFieldTests) ... ok
test_fk_to_fk (invalid_models_tests.test_relative_fields.ReverseQueryNameClashTests) ... ok
test_fk_to_integer (invalid_models_tests.test_relative_fields.ReverseQueryNameClashTests) ... ok
test_fk_to_m2m (invalid_models_tests.test_relative_fields.ReverseQueryNameClashTests) ... ok
test_m2m_to_fk (invalid_models_tests.test_relative_fields.ReverseQueryNameClashTests) ... ok
test_m2m_to_integer (invalid_models_tests.test_relative_fields.ReverseQueryNameClashTests) ... ok
test_m2m_to_m2m (invalid_models_tests.test_relative_fields.ReverseQueryNameClashTests) ... ok
test_accessor_clash (invalid_models_tests.test_relative_fields.SelfReferentialFKClashTests) ... ok
test_clash_under_explicit_related_name (invalid_models_tests.test_relative_fields.SelfReferentialFKClashTests) ... ok
test_reverse_query_name_clash (invalid_models_tests.test_relative_fields.SelfReferentialFKClashTests) ... ok
test_accessor_clash (invalid_models_tests.test_relative_fields.SelfReferentialM2MClashTests) ... ok
test_clash_between_accessors (invalid_models_tests.test_relative_fields.SelfReferentialM2MClashTests) ... ok
test_clash_under_explicit_related_name (invalid_models_tests.test_relative_fields.SelfReferentialM2MClashTests) ... ok
test_reverse_query_name_clash (invalid_models_tests.test_relative_fields.SelfReferentialM2MClashTests) ... ok
test_valid_model (invalid_models_tests.test_relative_fields.SelfReferentialM2MClashTests) ... ok

======================================================================
FAIL: test_ambiguous_relationship_model_from (invalid_models_tests.test_relative_fields.RelativeFieldTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/testbed/tests/invalid_models_tests/test_relative_fields.py", line 156, in test_ambiguous_relationship_model_from
    id='fields.E334',
AssertionError: Lists differ: [<Err[269 chars]int='Specify which foreign keys to use by addi[152 chars]34'>] != [<Err[269 chars]int='If you want to create a recursive relatio[146 chars]34'>]

First differing element 0:
<Erro[268 chars]int='Specify which foreign keys to use by addi[151 chars]334'>
<Erro[268 chars]int='If you want to create a recursive relatio[145 chars]334'>

Diff is 954 characters long. Set self.maxDiff to None to see it.

======================================================================
FAIL: test_ambiguous_relationship_model_to (invalid_models_tests.test_relative_fields.RelativeFieldTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/testbed/tests/invalid_models_tests/test_relative_fields.py", line 187, in test_ambiguous_relationship_model_to
    id='fields.E335',
AssertionError: Lists differ: [<Err[268 chars]int='Specify which foreign keys to use by addi[152 chars]35'>] != [<Err[268 chars]int='If you want to create a recursive relatio[146 chars]35'>]

First differing element 0:
<Erro[267 chars]int='Specify which foreign keys to use by addi[151 chars]335'>
<Erro[267 chars]int='If you want to create a recursive relatio[145 chars]335'>

Diff is 952 characters long. Set self.maxDiff to None to see it.

----------------------------------------------------------------------
Ran 84 tests in 0.190s

FAILED (failures=2)
Testing against Django installed in '/testbed/django'
Importing application invalid_models_tests
Skipping setup of unused database(s): default, other.
System check identified no issues (0 silenced).
+ git checkout a4881f5e5d7ee38b7e83301331a0b4962845ef8a tests/invalid_models_tests/test_relative_fields.py
Updated 1 path from 31f2a93b2e
